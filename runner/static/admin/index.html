<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Admin panel</title>
    <style>
     body {
       padding: 0 0.3rem 1rem;
       font-family: sans-serif;
       background-color: #eee;
     }
     section {
       box-shadow: 0px 0px 5px black;
       border-radius: 5px;
       padding: 0.2em 1em 1em;
       margin-bottom: 2rem;
     }
    </style>
  </head>
  <body>
    <h1>Katharsis.lol Admin panel</h1>

    <section>
      <h2>Vorstellung</h2>
      <h3>Vorstellung starten</h3>
      <form id="startScheduleForm">
        <label>
          <span>Url zum CSV Schedule</span>
          <input type="url" name="csvUrl" id="scheduleUrl">
        </label>
        <button type="submit">Schedule starten</button>
      </form>

      <h3>Vorstellung exportieren</h3>
      <p>Alle Chats der "Bühne" exportieren, die gerade existieren.</p>
      <form id="exportStageForm">
        <button type="submit">Vorstellung exportieren</button>
      </form>
    </section>

    <section>
      <h2>Haupträume</h2>
      <h3>Haupträume anlegen</h3>
      <form id="fillMainRoomForm">
        <div>
        <label>
          <span>Name der "Bühne"</span>
          <input type="text" name="mainstagename" id="mainstagename" placeholder="Bühne">
        </label>
        </div>
        <div>
        <label>
          <span>Name des "Writers Room"</span>
          <input type="text" name="backstagename" id="backstagename" placeholder="Writers Room">
        </label>
        </div>
        <button type="submit">Haupträume anlegen</button>
      </form>

      <h3>Haupträume löschen</h3>
      <form id="deleteMainRoomForm">
        <button type="submit">Bisherige Haupträume löschen</button>
      </form>
    </section>

    <section>
      <h2>Wörter und Anweisungen</h2>
      <h3>Wörter importieren</h3>
      <form id="importWordsForm">
        <label>
          <span>Url zum Wörter CSV</span>
          <input type="url" name="wordcsvurl" id="wordcsvurl">
        </label>
        <button type="submit">Wörter importieren</button>
      </form>
      <h3>Wort löschen</h3>
      <p><a href="/api/word" class="js-botname" target="_blank">Liste aller Wörter</a></p>
      <form id="deleteWordForm">
        <label>
          <span>Wort id</span>
          <input type="text" name="deletewordid" id="deletewordid" placeholder="">
          <button type="submit">Wort löschen</button>
        </label>
      </form>
      <h3>Alle Wörter löschen</h3>
      <form id="deleteAllWordsForm">
        <button type="submit">Alle Wörter löschen</button>
      </form>
      <h3>Anweisungen importieren</h3>
      <form id="importDirectionsForm">
        <label>
          <span>Url zum Anweisung CSV</span>
          <input type="url" name="directioncsvurl" id="directioncsvurl">
        </label>
        <button type="submit">Anweisungen importieren</button>
      </form>
      <h3>Anweisung löschen</h3>
      <p><a href="/api/direction" class="js-botname" target="_blank">Liste aller Anweisungen</a></p>
      <form id="deleteDirectionForm">
        <label>
          <span>Anweisung id</span>
          <input type="text" name="deletedirectionid" id="deletedirectionid" placeholder="">
          <button type="submit">Anweisung löschen</button>
        </label>
      </form>
      <h3>Alle Anweisungen löschen</h3>
      <form id="deleteAllDirectionsForm">
        <button type="submit">Alle Anweisungen löschen</button>
      </form>
    </section>

    <section>
      <h2>Räume und Chats</h2>
      <h3>Raum löschen</h3>
      <p><a href="/api/room" class="js-servername" target="_blank">Liste aller Räume</a></p>
      <form id="deleteRoomForm">
        <label>
          <span>Raum id</span>
          <input type="text" name="deleteroomid" id="deleteroomid" placeholder="">
          <button type="submit">Raum löschen</button>
        </label>
      </form>
      <h3>Alle Räume löschen (inkl Haupträume)</h3>
      <form id="deleteAllRoomsForm">
        <button type="submit">Alle Räume löschen</button>
      </form>
      <h3>Chat löschen</h3>
      <p><a href="/api/chat" class="js-servername" target="_blank">Liste aller Chats</a></p>
      <form id="deleteChatForm">
        <label>
          <span>Chat id</span>
          <input type="text" name="deletechatid" id="deletechatid" placeholder="">
          <button type="submit">Chat löschen</button>
        </label>
      </form>
      <h3>Chats eines Raumes löschen</h3>
      <form id="deleteChatsForRoomForm">
        <label>
          <span>Raum id</span>
          <input type="text" name="deletechatforroomid" id="deletechatforroomid" placeholder="">
          <button type="submit">Chats für diesen Raum löschen</button>
        </label>
      </form>
      <h3>Alle Chats löschen (inkl "Bühne")</h3>
      <form id="deleteAllChatsForm">
        <button type="submit">Alle Chats löschen</button>
      </form>
    </section>

    <section>
      <h2>User</h2>
      <p><a href="/api/user" class="js-servername" target="_blank">Liste aller User</a></p>
      <h3>User löschen</h3>
      <form id="deleteUserForm">
        <label>
          <span>User id</span>
          <input type="text" name="deleteuserid" id="deleteuserid" placeholder="">
          <button type="submit">User löschen</button>
        </label>
      </form>
      <h3>Alle User löschen (inkl Moderatoren)</h3>
      <form id="deleteAllUsersForm">
        <button type="submit">Alle User löschen</button>
      </form>
      <h3>User zu Moderator machen</h3>
      <form id="user2ModForm">
        <label>
          <span>User id</span>
          <input type="text" name="user2modid" id="user2modid" placeholder="">
          <button type="submit">User zu Moderator machen</button>
        </label>
      </form>
      <h3>Moderator zu User machen</h3>
      <form id="mod2UserForm">
        <label>
          <span>User id</span>
          <input type="text" name="mod2userid" id="mod2userid" placeholder="">
          <button type="submit">Moderator zu machen</button>
        </label>
      </form>
      <h3>User auf die "Bühne" holen</h3>
      <form id="user2stageForm">
        <label>
          <span>User id</span>
          <input type="text" name="user2stageid" id="user2stageid" placeholder="">
          <button type="submit">User onstage</button>
        </label>
      </form>
      <h3>User von der "Bühne" holen</h3>
      <form id="userOffstageForm">
        <label>
          <span>User id</span>
          <input type="text" name="useroffstageid" id="useroffstageid" placeholder="">
          <button type="submit">User offstage</button>
        </label>
      </form>
    </section>

    <script src="js/functions.js"></script>
    <script>
     let CONFIG = {};
     async function init() {
       let resp = await fetch('env.txt');
       let text = await resp.text();
       text.split('\n').forEach(x => {
         if (x !== '') {
           let parts = x.split("=");
           CONFIG[parts[0]] = parts[1];
         }
       });


       [...document.querySelectorAll('.js-servername')].map(x => {
         x.href = CONFIG.SERVER + x.href.replace(window.location.origin, "");
       });

       [...document.querySelectorAll('.js-botname')].map(x => {
         x.href = CONFIG.BOTBRAIN + x.href.replace(window.location.origin, "");
       });

       buildDeleteFunction('#deleteRoomForm', '#deleteroomid', `${CONFIG.SERVER}/api/room/`, 'Raum gelöscht:');
       buildDeleteFunction('#deleteChatForm', '#deletechatid', `${CONFIG.SERVER}/api/chat/`, 'Chat gelöscht:');
       buildDeleteFunction('#deleteUserForm', '#deleteuserid', `${CONFIG.SERVER}/api/user/`, 'User gelöscht:');
       buildDeleteFunction('#deleteWordForm', '#deletewordid', `${CONFIG.BOTBRAIN}/api/word/`, 'Wort gelöscht:');
       buildDeleteFunction('#deleteDirectionForm', '#deletedirectionid', `${CONFIG.BOTBRAIN}/api/direction/`, 'Anweisung gelöscht:');

       buildDeleteAllFunction('#deleteAllRoomsForm', `${CONFIG.SERVER}/api/room/`, 'Alle Räume gelöscht!');
       buildDeleteAllFunction('#deleteAllChatsForm', `${CONFIG.SERVER}/api/chat/`, 'Alle Chats gelöscht!');
       buildDeleteAllFunction('#deleteAllUsersForm', `${CONFIG.SERVER}/api/user/`, 'Alle User gelöscht!');

       buildBulkDeleteFunction('#deleteAllWordsForm', `${CONFIG.BOTBRAIN}/api/word/bulkdelete`, 'Alle Wörter gelöscht!');
       buildBulkDeleteFunction('#deleteAllDirectionsForm', `${CONFIG.BOTBRAIN}/api/direction/bulkdelete`, 'Alle Anweisungen gelöscht!');

       changeUserProperty('#user2ModForm', '#user2modid', '/api/user/user2mod/', 'User ist Moderator:', 'POST');
       changeUserProperty('#mod2UserForm', '#mod2userid', '/api/user/mod2user/', 'Moderator ist User:', 'POST');
       changeUserProperty('#user2stageForm', '#user2stageid', '/api/user/on/', 'Auf die Bühne:', 'POST');
       changeUserProperty('#userOffstageForm', '#useroffstageid', '/api/user/off/', 'Runter von der Bühne:', 'POST');

       buildImportFunction('#importWordsForm', '#wordcsvurl', `${CONFIG.BOTBRAIN}/api/word/bulkimport`);
       buildImportFunction('#importDirectionsForm', '#directioncsvurl', `${CONFIG.BOTBRAIN}/api/direction/bulkimport`);


       document.querySelector('#startScheduleForm').onsubmit = async (e) => {
       e.preventDefault();

       let formElem = document.querySelector('#scheduleUrl');
       let formObj = {};
       formObj[formElem.name] = formElem.value;

       let response = await fetch(`${CONFIG.RUNNER}/api/runschedule`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json;charset=utf-8'
         },
         body: JSON.stringify(formObj)
       });
       let result = await response.json();

       alert(result.message);
       formElem.value = "";
     };

     document.querySelector('#exportStageForm').onsubmit = async (e) => {
       e.preventDefault();

       let response = await fetch(`${CONFIG.SERVER}/api/room/main`);
       let rooms = await response.json();
       let mainstage = rooms.filter(x => x.locked == true);
       console.log(mainstage)

       let chatResponse = await fetch(`${CONFIG.SERVER}/api/chat/${mainstage[0]._id}`);
       let blob = await chatResponse.blob();
       const url = URL.createObjectURL(blob);

       const a = document.createElement('a');
       a.href = url;
       const d = new Date();
       a.download = `katharsislol-download-${ d.getTime() }`;

       const clickHandler = () => {
         setTimeout(() => {
           URL.revokeObjectURL(url);
           this.removeEventListener('click', clickHandler);
         }, 150);
       };
       a.addEventListener('click', clickHandler, false);
       a.click();
     }


     document.querySelector('#fillMainRoomForm').onsubmit = async (e) => {
       e.preventDefault();

       let mainStage = document.querySelector('#mainstagename')
       let backStage = document.querySelector('#backstagename')

       Promise.all([
         fetch(`${CONFIG.SERVER}/api/room`, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json;charset=utf-8'
           },
           body: JSON.stringify({room_name: mainStage.value,
                                 main: true,
                                 'private': false,
                                 locked: true})
         }),
         fetch(`${CONFIG.SERVER}/api/room`, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json;charset=utf-8'
           },
           body: JSON.stringify({room_name: backStage.value,
                                 main: true,
                                 'private': false,
                                 locked: false})
         })
       ]).then(blup => {
         alert("Räume angelegt!")
         mainStage.value = ''
         backStage.value = ''
       })
     }

     document.querySelector('#deleteMainRoomForm').onsubmit = async (e) => {
       e.preventDefault();

       let response = await fetch(`${CONFIG.SERVER}/api/room/main`);
       let mainrooms = await response.json();

       mainrooms.forEach(x => {
         fetch(`${CONFIG.SERVER}/api/room/${x._id}`, {
           method: 'DELETE'
         })
       })
       alert("Räume gelöscht!")
     }


     document.querySelector('#deleteChatsForRoomForm').onsubmit = async (e) => {
       e.preventDefault();
       let elem = document.querySelector('#deletechatforroomid');

       fetch(`${CONFIG.SERVER}/api/chat/${elem.value}`)
         .then(r => r.json())
         .then(values => {
           Promise.all(values.map(x => {
             fetch(`${CONFIG.SERVER}/api/chat/${x._id}`, {
               method: 'DELETE'
             }).then(resp => resp.json())
           })
           ).then(_ => {
             alert(`Alle Chats in Raum ${elem.value} gelöscht!`);
             elem.value = '';
           })
         })
     }

     }

     init();
    </script>
  </body>
</html>
